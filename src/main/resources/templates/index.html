<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ciencias de la Computaci√≥n 2</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<div th:fragment="header">
    <!-- ====== T√çTULO PRINCIPAL ====== -->
    <div class="header-principal">
        <h1 class="titulo-principal">Ciencias de la Computaci√≥n 2</h1>
    </div>

    <!-- ====== MEN√ö ====== -->
    <nav class="navbar">
        <ul class="menu">
            <li class="dropdown">
                <a href="#">B√∫squedas internas</a>
                <ul class="submenu">
                    <li class="dropdown">
                        <a href="#">Algoritmos de b√∫squeda</a>
                        <ul class="submenu">
                            <li><a href="#" class="menu-item" data-estructura="lineal">B√∫squeda Lineal</a></li>
                            <li><a href="#" class="menu-item" data-estructura="binaria">B√∫squeda Binaria</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Funciones hash</a>
                        <ul class="submenu">
                            <li><a href="#" class="menu-item" data-estructura="hash" data-alg="mod">Hash mod</a></li>
                            <li><a href="#" class="menu-item" data-estructura="hash" data-alg="cuadrado">Hash cuadrado</a></li>
                            <li><a href="#" class="menu-item" data-estructura="hash" data-alg="plegamiento">Hash plegamiento</a></li>
                            <li><a href="#" class="menu-item" data-estructura="hash" data-alg="truncamiento">Hash truncamiento</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#">B√∫squedas externas</a>
                <ul class="submenu">
                    <li class="dropdown">
                        <a href="#">Algoritmos de b√∫squeda por bloques</a>
                        <ul class="submenu">
                            <li><a href="#" class="menu-item" data-feature="lineal-bloques">B√∫squeda Lineal por Bloques</a></li>
                            <li><a href="#" class="menu-item" data-feature="binaria-bloques">B√∫squeda Binaria por Bloques</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#">Funciones hash por bloques</a>
                        <ul class="submenu">
                            <li><a href="#" class="menu-item" data-feature="hash-mod-bloques">Hash mod por Bloques</a></li>
                            <li><a href="#" class="menu-item" data-feature="hash-cuadrado-bloques">Hash cuadrado por Bloques</a></li>
                            <li><a href="#" class="menu-item" data-feature="hash-plegamiento-bloques">Hash plegamiento por Bloques</a></li>
                            <li><a href="#" class="menu-item" data-feature="hash-truncamiento-bloques">Hash truncamiento por Bloques</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#">√Årboles</a>
                <ul class="submenu">
                    <li><a href="#" class="menu-item" data-estructura="arboles-digitales">√Årboles Digitales</a></li>
                    <li><a href="#" class="menu-item" data-estructura="tries-residuos">√Årboles por Residuos</a></li>
                    <li><a href="#" class="menu-item" data-estructura="tries-residuos-multiples">√Årboles por Residuos M√∫ltiples</a></li>
                    <li><a href="#" class="menu-item" data-feature="huffman">√Årbol de Huffman</a></li>
                </ul>
            </li>
            <li class="dropdown">
                <a href="#">Estructuras din√°micas</a>
                <ul class="submenu">
                    <li><a href="#" class="menu-item" data-feature="expansion-total">Expansi√≥n Total</a></li>
                    <li><a href="#" class="menu-item" data-feature="expansion-parcial">Expansi√≥n Parcial</a></li>
                </ul>
            </li>
        </ul>
    </nav>
</div>

<!-- ====== CONTENEDOR PRINCIPAL ====== -->
<div class="main-container">
    <!-- ====== MEN√ö LATERAL ====== -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 id="sidebar-title">Selecciona una estructura</h2>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="sidebar-option">Crear</a></li>
            <li><a href="#" class="sidebar-option">Insertar</a></li>
            <li><a href="#" class="sidebar-option">Guardar</a></li>
            <li><a href="#" class="sidebar-option">Recuperar</a></li>
            <li><a href="#" class="sidebar-option">Imprimir</a></li>
            <li><a href="#" class="sidebar-option">Buscar</a></li>
            <li><a href="#" class="sidebar-option">Eliminar</a></li>
        </ul>
    </div>

    <!-- ====== CONTENIDO ====== -->
    <div class="contenido">
        <!-- Secci√≥n inicial (se oculta para Lineal y Binaria) -->
        <div class="contenido-inicial" id="contenido-inicial">
            <div class="titulo">Selecciona una estructura de datos para comenzar</div>
            <div class="subtitulo">
                Elige una opci√≥n en la barra de navegaci√≥n superior para realizar operaciones con diferentes estructuras de datos.
            </div>
        </div>

        <!-- Contenedor de trabajo (se muestra para Lineal y Binaria) -->
        <div class="contenedor-trabajo" id="contenedor-trabajo">
            <!-- Panel izquierdo: Opciones del usuario -->
            <div class="panel-opciones">
                <h3 class="panel-titulo">Opciones</h3>
                <div class="opciones-contenedor" id="opciones-contenedor">
                    <!-- Las opciones se generan din√°micamente aqu√≠ -->
                </div>
            </div>

            <!-- Panel derecho: Visualizaci√≥n de la estructura -->
            <div class="panel-visualizacion">
                <h3 class="panel-titulo">Estructura</h3>
                <div class="scroll-contenedor" id="scroll-contenedor">
                    <div class="estructura-canvas" id="estructura-canvas">
                        <!-- La estructura visual se genera aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Panel inferior: Comentarios -->
            <div class="panel-comentarios" id="panel-comentarios">
                <div class="comentario-icono">‚ÑπÔ∏è</div>
                <div class="comentario-texto" id="comentario-texto">
                    Selecciona una acci√≥n del men√∫ lateral para comenzar
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const menuItems = document.querySelectorAll('.menu-item');
    const sidebarTitle = document.getElementById('sidebar-title');
    const contenidoInicial = document.getElementById('contenido-inicial');
    const contenedorTrabajo = document.getElementById('contenedor-trabajo');
    const comentarioTexto = document.getElementById('comentario-texto');
    const opcionesContenedor = document.getElementById('opciones-contenedor');
    const sidebarOptions = document.querySelectorAll('.sidebar-option');

    // helper to show placeholder for unsupported options
    function showFeaturePlaceholder(text) {
        comentarioTexto.textContent = `‚è≥ Funcionalidad "${text}" a√∫n no disponible`;
        // keep workspace hidden
        contenidoInicial.style.display = 'block';
        contenedorTrabajo.classList.remove('show');
        estructuraActual = null;
    }

    // estado global de la estructura (servidor) para uso en visualizaci√≥n / validaciones
    let estructuraActual = null;
let hashAlg = null; // algoritmo hash seleccionado cuando estructuraActual === 'hash'
    let tamanoClaves = 0;

    // helpers para comentarios/logs
    function setComentario(text) {
        comentarioTexto.innerHTML = text;
    }
    function log(text) {
        console.log(text);
        // agregar con salto de l√≠nea, cuidando no borrar mensaje principal si ya hay uno
        comentarioTexto.innerHTML += '<br>' + text;
    }
    function procesarLogs(data) {
        if (data.logs && Array.isArray(data.logs)) {
            data.logs.forEach(l => log(l));
        }
    }

    const estructuraNames = {
        'lineal': 'Estructura Lineal',
        'binaria': 'Estructura Binaria',
        'arboles-digitales': '√Årboles Digitales',
        'tries-residuos': 'Tries por Residuos',
        'tries-residuos-multiples': 'Tries por Residuos M√∫ltiples'
    };

    const estructurasConPanel = ['lineal', 'binaria', 'hash'];

    // cualquier estructura que termine en '-bloques' tambi√©n muestra panel lateral
    function esEstructuraConPanel(estructura) {
        return estructurasConPanel.includes(estructura) || (estructura && estructura.endsWith('-bloques'));    
    }

    // Evento para items del men√∫ principal (ahora con men√∫ jer√°rquico)
    menuItems.forEach(item => {
        item.addEventListener('click', async function(e) {
            e.preventDefault();
            const estructura = this.dataset.estructura;
            const feature = this.dataset.feature;
            const text = this.textContent.trim();
            // limpiar estructura previa en servidor para evitar cruce de estados
            if (estructura || feature) {
                try {
                    await fetch('/api/estructura/eliminar-estructura', { method: 'POST' });
                } catch (_) {
                    // ignore errors
                }
            }

            if (estructura) {
                // handle hash specially
                if (estructura === 'hash') {
                    hashAlg = this.dataset.alg;
                    sidebarTitle.textContent = `Hash (${hashAlg})`;
                } else {
                    sidebarTitle.textContent = estructuraNames[estructura] || text;
                }
                estructuraActual = estructura;

                // cuando cambiamos de estructura, limpiamos estado previo
                tamanoMaximo = 0;
                tamanoClaves = 0;
                hashAlg = (estructura === 'hash') ? hashAlg : null;
                opcionesContenedor.innerHTML = '';
                document.getElementById('estructura-canvas').innerHTML = '';

                // Mostrar u ocultar el contenedor de trabajo
                if (esEstructuraConPanel(estructura)) {
                    contenidoInicial.style.display = 'none';
                    contenedorTrabajo.classList.add('show');
                    comentarioTexto.textContent = `${sidebarTitle.textContent} cargada. Selecciona una acci√≥n del men√∫ lateral.`;
                } else {
                    contenidoInicial.style.display = 'block';
                    contenedorTrabajo.classList.remove('show');
                }
            } else if (feature) {
                // treat external search methods as estructuras independientes
                const isExternal = feature === 'lineal-bloques' || feature === 'binaria-bloques'
                                   || (feature.startsWith('hash-') && feature.endsWith('-bloques'));
                if (isExternal) {
                    estructuraActual = feature;
                    sidebarTitle.textContent = text;

                    // reset state
                    tamanoMaximo = 0;
                    tamanoClaves = 0;
                    hashAlg = null;
                    opcionesContenedor.innerHTML = '';
                    document.getElementById('estructura-canvas').innerHTML = '';

                    contenidoInicial.style.display = 'none';
                    contenedorTrabajo.classList.add('show');
                    comentarioTexto.textContent = `${sidebarTitle.textContent} seleccionada. Usa el men√∫ lateral para Crear/Insertar/Buscar/Eliminar.`;
                } else {
                    showFeaturePlaceholder(text);
                }
            } else {
                // item without data attributes (maybe parent menus) ignore
            }
        });
    });

    // Evento para opciones del men√∫ lateral
    sidebarOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const accion = this.textContent.trim();

            if (!estructuraActual || !esEstructuraConPanel(estructuraActual)) {
                alert('Por favor selecciona primero un m√©todo v√°lido (interno o de bloques) en el men√∫ superior');
                return;
            }

            // Limpiar opciones previas
            opcionesContenedor.innerHTML = '';

            // Mostrar formulario seg√∫n la acci√≥n
            if (accion === 'Crear') {
                mostrarFormularioCrear();
                comentarioTexto.textContent = 'üìù Completa los campos necesarios para crear la estructura';
            } else if (accion === 'Insertar') {
                mostrarFormularioInsertar();
                comentarioTexto.textContent = '‚ûï Ingresa el valor a insertar en la estructura';
            } else if (accion === 'Buscar') {
                mostrarFormularioBuscar();
                comentarioTexto.textContent = 'üîç Ingresa el valor a buscar en la estructura';
            } else if (accion === 'Eliminar') {
                mostrarFormularioEliminar();
                comentarioTexto.textContent = 'üóëÔ∏è Selecciona una acci√≥n para eliminar';
            } else {
                opcionesContenedor.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: rgba(212, 212, 212, 0.7);">
                        Funcionalidad de "${accion}" a√∫n no disponible
                    </div>
                `;
                comentarioTexto.textContent = `‚è≥ La opci√≥n "${accion}" est√° en desarrollo`;
            }
        });
    });

    // Funci√≥n para mostrar formulario de Crear
    function mostrarFormularioCrear() {
        let extra = '';
        // si es alg√∫n tipo de bloque, pedir n√∫mero de bloques
        if (estructuraActual && estructuraActual.endsWith('-bloques')) {
            extra += `
            <div class="form-group">
                <label for="num-bloques">N√∫mero de Bloques</label>
                <input type="number" id="num-bloques" placeholder="Ej: 3" min="1">
            </div>`;
        }
        // si es hash interno o externo, pedir m√≥dulo opcional
        if (estructuraActual && (estructuraActual === 'hash' || estructuraActual.startsWith('hash-')) ) {
            extra += `
            <div class="form-group">
                <label for="modulo-hash">M√≥dulo para hash (opcional)</label>
                <input type="number" id="modulo-hash" placeholder="Si no se indica se usa tama√±o" min="1">
            </div>`;
        }

        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="tamano-arreglo">Tama√±o del Arreglo</label>
                <input type="number" id="tamano-arreglo" placeholder="Ej: 10" min="1" max="100">
            </div>

            <div class="form-group">
                <label for="tamano-claves">Tama√±o de las Claves</label>
                <input type="number" id="tamano-claves" placeholder="Ej: 5" min="1" max="50">
            </div>

            <div class="form-group">
                <label>Tipo de L√≠mite</label>
                <div class="radio-group">
                    <div class="radio-wrapper">
                        <input type="radio" id="limite-estatico" name="limite" value="estatico" checked>
                        <label for="limite-estatico">Est√°tico</label>
                    </div>
                    <div class="radio-wrapper">
                        <input type="radio" id="limite-dinamico" name="limite" value="dinamico">
                        <label for="limite-dinamico">Din√°mico</label>
                    </div>
                </div>
            </div>
            ${extra}
            <button class="btn-accion" id="btn-crear">Crear Estructura</button>
        `;

        document.getElementById('btn-crear').addEventListener('click', async function() {
            const tamanoArreglo = document.getElementById('tamano-arreglo').value;
            let localTamanoClaves = document.getElementById('tamano-claves').value; // nombre distinto para no chocar con variable global
            const tipeLimite = document.querySelector('input[name="limite"]:checked').value;

            if (!tamanoArreglo || !localTamanoClaves) {
                setComentario('‚ùå Por favor completa todos los campos');
                return;
            }

            setComentario('‚è≥ Creando estructura...');
            
            try {
                let url = `/api/estructura/crear?tipo=${estructuraActual}&tamano=${tamanoArreglo}&tamanoClaves=${localTamanoClaves}&tipeLimite=${tipeLimite}`;
                if (estructuraActual.endsWith('-bloques')) {
                    const nb = document.getElementById('num-bloques').value;
                    if (nb) url += `&numBloques=${encodeURIComponent(nb)}`;
                }
                if ((estructuraActual === 'hash' || estructuraActual.startsWith('hash-'))) {
                    const mod = document.getElementById('modulo-hash')?.value;
                    if (mod) {
                        url += `&modulo=${encodeURIComponent(mod)}`;
                    }
                }
                // internal hash algo is determined elsewhere (sidebar); external hash type already encoded in estructuraActual
                if (estructuraActual === 'hash' && hashAlg) {
                    url += `&alg=${encodeURIComponent(hashAlg)}`;
                }

                const response = await fetch(url, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    setComentario(`‚úÖ ${data.mensaje}`);
                    // guardar tama√±os para visualizaci√≥n futura
                    tamanoMaximo = data.tamano || tamanoMaximo;
                    tamanoClaves = data.tamanoClaves || tamanoClaves; // actualizaci√≥n global
                    visualizarEstructura(data.claves);
                    procesarLogs(data);
                    document.getElementById('estructura-canvas').innerHTML += `
                        <button class="btn-accion btn-secundario" id="btn-limpiar" style="margin-top: 10px; background: #dc3545;">
                            Limpiar y Crear Nueva
                        </button>
                    `;
                    document.getElementById('btn-limpiar').addEventListener('click', eliminarEstructura);
                } else {
                    setComentario(`‚ùå ${data.mensaje}`);
                    procesarLogs(data);
                }
            } catch (error) {
                setComentario('‚ùå Error de conexi√≥n: ' + error.message);
            }
        });
    }

    // Funci√≥n para mostrar formulario de Insertar
    function mostrarFormularioInsertar() {
        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="valor-insertar">Valor a Insertar</label>
                <input type="text" id="valor-insertar" placeholder="Ingresa el valor">
            </div>

            <button class="btn-accion" id="btn-insertar">Insertar</button>
            <button class="btn-accion btn-secundario" id="btn-repetir-insertar" style="background: #17a2b8; display: none; margin-top:10px;">
                üîÑ Repetir Animaci√≥n
            </button>
        `;
        let ultimosResultados = null;

        const btnRepetirInsertar = document.getElementById('btn-repetir-insertar');
        document.getElementById('btn-insertar').addEventListener('click', async function() {
            const valor = document.getElementById('valor-insertar').value;
            if (!valor) {
                setComentario('‚ùå Por favor ingresa un valor');
                return;
            }
            // validar longitud de clave en cliente tambi√©n
            if (tamanoClaves && valor.length !== tamanoClaves) {
                setComentario(`‚ùå La clave debe tener exactamente ${tamanoClaves} caracteres`);
                return;
            }

            setComentario('‚è≥ Insertando clave...');
            try {
                const response = await fetch(`/api/estructura/insertar?clave=${valor}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    setComentario(`‚úÖ ${data.mensaje}`);
                    procesarLogs(data);
                    ultimosResultados = data;
                    // si hay pasos de animaci√≥n, mu√©strala
                    if (data.pasos && data.pasos.length > 0) {
                        mostrarAnimacionBusqueda(data);
                        btnRepetirInsertar.style.display = 'block';
                    } else {
                        visualizarEstructura(data.claves);
                    }
                    document.getElementById('valor-insertar').value = '';
                } else {
                    setComentario(`‚ùå ${data.mensaje}`);
                    procesarLogs(data);
                }
            } catch (error) {
                setComentario('‚ùå Error de conexi√≥n: ' + error.message);
            }
        });
        btnRepetirInsertar.addEventListener('click', function() {
            if (ultimosResultados) {
                mostrarAnimacionBusqueda(ultimosResultados);
            }
        });
    }


    // Funci√≥n para mostrar formulario de Buscar
    function mostrarFormularioBuscar() {
        // campos extras seg√∫n la estructura seleccionada
        let extras = '';
        if (estructuraActual && estructuraActual.endsWith('-bloques')) {
            extras += `
            <div class="form-group">
                <label for="num-bloques">N√∫mero de Bloques</label>
                <input type="number" id="num-bloques" placeholder="Ej: 3" min="1">
            </div>

            <div class="form-group">
                <label>M√©todo dentro del bloque</label>
                <div class="radio-group">
                    <div class="radio-wrapper">
                        <input type="radio" id="busqueda-lineal-bloque" name="metodo-bloque" value="lineal" checked>
                        <label for="busqueda-lineal-bloque">Lineal</label>
                    </div>
                    <div class="radio-wrapper">
                        <input type="radio" id="busqueda-binaria-bloque" name="metodo-bloque" value="binaria">
                        <label for="busqueda-binaria-bloque">Binaria</label>
                    </div>
                </div>
            </div>`;
        }
        if (estructuraActual && estructuraActual.startsWith('hash-') && estructuraActual.endsWith('-bloques')) {
            extras += `
            <div class="form-group">
                <label for="modulo-bloques">M√≥dulo (opcional)</label>
                <input type="number" id="modulo-bloques" placeholder="Si no se indica se usa tama√±o" min="1">
            </div>`;
        }

        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="valor-buscar">Valor a Buscar</label>
                <input type="text" id="valor-buscar" placeholder="Ingresa el valor a buscar">
            </div>
            ${extras}
            <button class="btn-accion" id="btn-buscar">Buscar</button>
            <button class="btn-accion btn-secundario" id="btn-repetir" style="background: #17a2b8; display: none;">
                üîÑ Repetir Animaci√≥n
            </button>
        `;

        const btnBuscar = document.getElementById('btn-buscar');
        const btnRepetir = document.getElementById('btn-repetir');
        let ultimosResultados = null;

        btnBuscar.addEventListener('click', async function() {
            const valor = document.getElementById('valor-buscar').value;
            if (!valor) {
                setComentario('‚ùå Por favor ingresa un valor');
                return;
            }
            if (tamanoClaves && valor.length !== tamanoClaves) {
                setComentario(`‚ùå La clave debe tener exactamente ${tamanoClaves} caracteres`);
                return;
            }

            // gather extra params
            let params = `clave=${encodeURIComponent(valor)}`;
            if (estructuraActual && estructuraActual.endsWith('-bloques')) {
                const nb = document.getElementById('num-bloques').value;
                const bin = document.querySelector('input[name="metodo-bloque"]:checked').value === 'binaria';
                if (nb) params += `&numBloques=${encodeURIComponent(nb)}`;
                params += `&binarioEnBloque=${bin}`;
            }
            if (estructuraActual && estructuraActual.startsWith('hash-') && estructuraActual.endsWith('-bloques')) {
                const mod = document.getElementById('modulo-bloques').value;
                if (mod) params += `&modulo=${encodeURIComponent(mod)}`;
            }

            setComentario('‚è≥ Buscando...');
            
            try {
                const response = await fetch(`/api/estructura/buscar?${params}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    ultimosResultados = data;
                    btnRepetir.style.display = 'block';
                    
                    if (data.encontrado) {
                        setComentario(`‚úÖ ${data.mensaje}`);
                    } else {
                        setComentario(`‚ùå ${data.mensaje}`);
                    }
                    
                    // Mostrar animaci√≥n
                    mostrarAnimacionBusqueda(data);
                } else {
                    setComentario(`‚ùå ${data.mensaje}`);
                }
            } catch (error) {
                setComentario('‚ùå Error de conexi√≥n: ' + error.message);
            }
        });

        btnRepetir.addEventListener('click', function() {
            if (ultimosResultados) {
                mostrarAnimacionBusqueda(ultimosResultados);
            }
        });
    }

    // Funci√≥n para mostrar animaci√≥n de b√∫squeda - COMPLETAMENTE REESCRITA PARA SOPORTAR BLOQUES
    async function mostrarAnimacionBusqueda(datos) {
        const canvas = document.getElementById('estructura-canvas');
        const pasos = datos.pasos || [];
        const clavesAnim = datos.clavesAntes || datos.claves || [];
        
        if (pasos.length === 0) {
            canvas.innerHTML = '<p style="color: #007bff;">No hay pasos para mostrar</p>';
            return;
        }
        
        // Detectar si se trata de una b√∫squeda por bloques o hash
        const esBloque = pasos.some(p => p.tipo === 'bloque-scan' || p.etapaAlgoritmo === 'bloque_seleccion');
        const esHash = pasos.some(p => p.tipo === 'hash' || p.etapaAlgoritmo === 'hash_calculo');
        let numBloques = 1;
        
        if (esBloque) {
            // Detectar n√∫mero de bloques del primer paso de bloque
            const primerPasoBloque = pasos.find(p => p.tipo === 'bloque-scan');
            if (primerPasoBloque && primerPasoBloque.numBloque !== undefined) {
                numBloques = Math.max(...pasos.filter(p => p.numBloque !== null && p.numBloque !== undefined).map(p => p.numBloque)) + 1;
            }
        }
        
        const mostrarPaso = async (index) => {
            if (index >= pasos.length) {
                // √öltima visualizaci√≥n - mostrar estructura final
                const clavesFinales = datos.claves || clavesAnim;
                if (esBloque) {
                    visualizarBloques(clavesFinales, datos.numBloques || numBloques, -1, -1);
                } else {
                    visualizarEstructuraConMarcado(clavesFinales, datos.encontrado ? datos.posicion : -1, true);
                }
                // si tenemos lista despu√©s (eliminaci√≥n), actualizamos
                if (datos.clavesDespues) {
                    await new Promise(r => setTimeout(r, 500));
                    if (esBloque) {
                        visualizarBloques(datos.clavesDespues, datos.numBloques || numBloques);
                    } else {
                        visualizarEstructura(datos.clavesDespues);
                    }
                }
                return;
            }

            const paso = pasos[index];
            
            // Seleccionar visualizaci√≥n seg√∫n tipo de paso
            if (esBloque) {
                // Para b√∫squedas por bloques
                if (paso.tipo === 'bloque-scan') {
                    // Marcar el bloque siendo escaneado
                    visualizarBloques(clavesAnim, datos.numBloques || numBloques, paso.numBloque, paso.indiceActual);
                } else if (paso.tipo === 'interno-bloque' || paso.tipo === 'interno-bloque-binaria') {
                    // Mostrar elemento dentro del bloque
                    visualizarBloques(clavesAnim, datos.numBloques || numBloques, paso.numBloque, paso.indiceActual);
                } else if (paso.tipo === 'hash') {
                    // Paso de c√°lculo de hash
                    visualizarBloques(clavesAnim, datos.numBloques || numBloques, -1, -1);
                }
            } else {
                // B√∫squeda normal (lineal, binaria simple, hash-interno)
                visualizarEstructuraConMarcado(clavesAnim, paso.indiceActual || paso.medio, false);
            }

            comentarioTexto.innerHTML = obtenerTextoAnimacion(paso, pasos, index, numBloques);

            await new Promise(resolve => setTimeout(resolve, 800));
            mostrarPaso(index + 1);
        };
        
        mostrarPaso(0);
    }

    // NUEVA: Funci√≥n para visualizar estructura en bloques
    function visualizarBloques(claves, numBloques, bloqueResaltado, itemResaltado) {
        const canvas = document.getElementById('estructura-canvas');
        
        if (numBloques <= 0) numBloques = 1;
        const totalItems = tamanoMaximo || claves.length || 0;
        const blockSize = Math.ceil(totalItems / numBloques);
        
        let html = '<div class="bloques-contenedor" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 10px;">';
        
        for (let b = 0; b < numBloques; b++) {
            const start = b * blockSize;
            const end = Math.min(start + blockSize - 1, totalItems - 1);
            
            const esResaltado = b === bloqueResaltado;
            const clasesBloque = esResaltado ? 'bloque-item bloque-resaltado' : 'bloque-item';
            
            html += `<div class="${clasesBloque}" style="border: 2px solid ${esResaltado ? '#007bff' : '#cccccc'}; border-radius: 8px; padding: 12px; background: ${esResaltado ? 'rgba(0, 123, 255, 0.1)' : '#f9f9f9'}; transition: all 0.3s ease;">`;
            html += `<div style="font-weight: 600; font-size: 12px; color: #007bff; margin-bottom: 8px;">‚ñ∂ Bloque ${b} [${start}...${end}]</div>`;
            
            for (let i = start; i <= end && i < totalItems; i++) {
                const valor = i < claves.length ? claves[i] : '';
                let claseItem = 'bloque-elemento';
                
                if (i === itemResaltado) {
                    claseItem += ' elemento-marcado';
                }
                
                html += `<div class="${claseItem}" style="padding: 6px; margin: 4px 0; background: ${i === itemResaltado ? 'rgba(0, 123, 255, 0.3)' : '#fff'}; border: 1px solid ${i === itemResaltado ? '#007bff' : '#ddd'}; border-radius: 4px; display: flex; gap: 8px; align-items: center; font-size: 12px; transition: all 0.3s ease;">
                    <span style="font-weight: 600; color: #007bff; background: rgba(0,123,255,0.08); padding: 2px 6px; border-radius: 3px;">${i}</span>
                    <span>${valor}</span>
                </div>`;
            }
            
            html += '</div>';
        }
        
        html += '</div>';
        canvas.innerHTML = html;
    }

    // ACTUALIZADA: Funci√≥n para obtener texto de animaci√≥n con manejo de bloques y hash
    function obtenerTextoAnimacion(paso, pasos, indiceActual, numBloques) {
        let texto = `<strong>Paso ${indiceActual + 1}/${pasos.length}:</strong> `;

        if (paso.tipo === 'hash') {
            // Mostrar c√°lculo de funci√≥n hash
            texto += `<br><strong>C√°lculo Hash:</strong><br>`;
            if (paso.formulaHash) {
                texto += `<code style="background: #f0f0f0; padding: 4px 8px; border-radius: 3px;">${paso.formulaHash}</code><br>`;
            }
            texto += `Clave: <strong>${paso.valorActual}</strong> ‚Üí √çndice: <strong>${paso.indiceHashCalculado}</strong><br>`;
            texto += `Bloque asignado: <strong>Bloque ${Math.floor(paso.indiceHashCalculado / numBloques)}</strong>`;
        } else if (paso.tipo === 'bloque-scan') {
            // Mostrar escaneo de bloque
            const esBloqueFinal = paso.numBloque !== undefined;
            const accion = indiceActual === 0 ? 'Iniciando b√∫squeda' : 'Examinando';
            texto += `${accion} <strong>Bloque ${paso.numBloque}</strong> [${paso.bloqueInicio}...${paso.bloqueFinal}]<br>`;
            texto += `Valor medio: <strong>${paso.valorActual}</strong>`;
        } else if (paso.tipo === 'interno-bloque') {
            // B√∫squeda lineal dentro del bloque
            texto += `<strong>B√∫squeda Interna (Lineal)</strong> en Bloque ${paso.numBloque}<br>`;
            texto += `Comparando posici√≥n ${paso.indiceActual}: <strong>${paso.valorActual}</strong>`;
            if (paso.esCoincidencia) {
                texto += ` ‚úÖ <strong style="color: #28a745;">¬°ENCONTRADO!</strong>`;
            }
        } else if (paso.tipo === 'interno-bloque-binaria') {
            // B√∫squeda binaria dentro del bloque
            texto += `<strong>B√∫squeda Interna (Binaria)</strong> en Bloque ${paso.numBloque}<br>`;
            texto += `Rango [${paso.izquierda}, ${paso.derecha}], Medio: ${paso.medio}<br>`;
            texto += `Valor: <strong>${paso.valorActual}</strong>`;
            if (paso.comparacionResultado) {
                const comparacion = paso.comparacionResultado === 'menor' ? '&lt; (buscar izq)' : (paso.comparacionResultado === 'mayor' ? '&gt; (buscar der)' : '= ‚úÖ ENCONTRADO');
                texto += ` ${comparacion}`;
            }
        } else if (paso.tipo === 'lineal') {
            // B√∫squeda lineal simple
            texto += `Comparando posici√≥n ${paso.indiceActual} (valor: <strong>${paso.valorActual}</strong>)`;
            if (paso.esCoincidencia) {
                texto += ` ‚úÖ <strong style="color: #28a745;">¬°ENCONTRADO!</strong>`;
            }
        } else if (paso.tipo === 'binaria') {
            // B√∫squeda binaria simple
            texto += `B√∫squeda Binaria - Rango [${paso.izquierda}, ${paso.derecha}], Medio: ${paso.medio}<br>`;
            texto += `Valor: <strong>${paso.valorActual}</strong>`;
            if (paso.esCoincidencia) {
                texto += ` ‚úÖ <strong style="color: #28a745;">¬°ENCONTRADO!</strong>`;
            }
        }
        
        return texto;
    }

    // Funci√≥n para visualizar estructura con marcado (usando divs en lugar de tabla)
    function visualizarEstructuraConMarcado(claves, indiceMarcado, destacarCompleto) {
        const canvas = document.getElementById('estructura-canvas');
        let html = '<div class="estructura-contenedor">';
        
        // Usar tamanoMaximo o la longitud de claves si no est√° definido
        const totalItems = tamanoMaximo || claves.length || 0;
        
        for (let i = 0; i < totalItems; i++) {
            const valor = i < claves.length ? claves[i] : '';
            let clases = 'estructura-item';
            
            // Agregar clases din√°micas seg√∫n el estado
            if (i === indiceMarcado && !destacarCompleto) {
                clases += ' item-marcado';
            }
            if (destacarCompleto && i === indiceMarcado) {
                clases += ' item-encontrado';
            }
            
            html += `<div class="${clases}" data-index="${i}">
                        <div class="posicion">${i}</div>
                        <div class="clave">${valor}</div>
                     </div>`;
        }
        
        html += '</div>';
        canvas.innerHTML = html;
    }

    // Funci√≥n para visualizar estructura completa usando divs
    function visualizarEstructura(claves) {
        // Asegurar que tamanoMaximo est√° definido
        if (!tamanoMaximo || tamanoMaximo === 0) {
            tamanoMaximo = Math.max(claves.length, 5); // m√≠nimo 5 espacios si no se env√≠a desde backend
        }
        visualizarEstructuraConMarcado(claves, -1, false);
    }

    // Funci√≥n para eliminar estructura
    async function eliminarEstructura() {
        setComentario('‚è≥ Eliminando estructura...');
        
        try {
            const response = await fetch('/api/estructura/eliminar-estructura', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.exito) {
                setComentario(`‚úÖ ${data.mensaje}`);
                procesarLogs(data);
                opcionesContenedor.innerHTML = '';
                document.getElementById('estructura-canvas').innerHTML = 
                    '<p style="color: rgba(212, 212, 212, 0.7);">Estructura eliminada. Selecciona "Crear" para empezar de nuevo.</p>';
            }
        } catch (error) {
            setComentario('‚ùå Error: ' + error.message);
        }
    }

    // Funci√≥n para mostrar formulario de Eliminar
    function mostrarFormularioEliminar() {
        // campos extras seg√∫n estructura actual
        let extras = '';
        if (estructuraActual && estructuraActual.endsWith('-bloques')) {
            extras += `
            <div class="form-group">
                <label for="num-bloques">N√∫mero de Bloques</label>
                <input type="number" id="num-bloques" placeholder="Ej: 3" min="1">
            </div>
            <div class="form-group">
                <label>M√©todo dentro del bloque</label>
                <div class="radio-group">
                    <div class="radio-wrapper">
                        <input type="radio" id="delete-lineal-bloque" name="metodo-bloque" value="lineal" checked>
                        <label for="delete-lineal-bloque">Lineal</label>
                    </div>
                    <div class="radio-wrapper">
                        <input type="radio" id="delete-binaria-bloque" name="metodo-bloque" value="binaria">
                        <label for="delete-binaria-bloque">Binaria</label>
                    </div>
                </div>
            </div>`;
        }
        if (estructuraActual && estructuraActual.startsWith('hash-') && estructuraActual.endsWith('-bloques')) {
            extras += `
            <div class="form-group">
                <label for="modulo-bloques">M√≥dulo (opcional)</label>
                <input type="number" id="modulo-bloques" placeholder="Si no se indica se usa tama√±o" min="1">
            </div>`;
        }

        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="valor-eliminar">Valor a Eliminar</label>
                <input type="text" id="valor-eliminar" placeholder="Ingresa el valor a eliminar">
            </div>
            ${extras}

            <button class="btn-accion" id="btn-eliminar">Eliminar Clave</button>
            <button class="btn-accion btn-secundario" id="btn-repetir-eliminar" style="background: #dc3545 !important; display: none;">
                üîÑ Repetir Animaci√≥n
            </button>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0, 123, 255, 0.2);">
                <h4 style="color: #007bff; margin-top: 0;">Acciones Adicionales</h4>
                <button class="btn-accion" id="btn-limpiar-estruc" style="background: #dc3545 !important; width: 100%;">
                    üóëÔ∏è Borrar Toda la Estructura
                </button>
            </div>
        `;

        const btnEliminar = document.getElementById('btn-eliminar');
        const btnRepetirEliminar = document.getElementById('btn-repetir-eliminar');
        const btnLimpiar = document.getElementById('btn-limpiar-estruc');
        let ultimosResultados = null;

        btnEliminar.addEventListener('click', async function() {
            const valor = document.getElementById('valor-eliminar').value;
            if (!valor) {
                setComentario('‚ùå Por favor ingresa un valor');
                return;
            }
            if (tamanoClaves && valor.length !== tamanoClaves) {
                setComentario(`‚ùå La clave debe tener exactamente ${tamanoClaves} caracteres`);
                return;
            }

            // build params
            let params = `clave=${encodeURIComponent(valor)}`;
            if (estructuraActual && estructuraActual.endsWith('-bloques')) {
                const nb = document.getElementById('num-bloques').value;
                const bin = document.querySelector('input[name="metodo-bloque"]:checked').value === 'binaria';
                if (nb) params += `&numBloques=${encodeURIComponent(nb)}`;
                params += `&binarioEnBloque=${bin}`;
            }
            if (estructuraActual && estructuraActual.startsWith('hash-') && estructuraActual.endsWith('-bloques')) {
                const mod = document.getElementById('modulo-bloques').value;
                if (mod) params += `&modulo=${encodeURIComponent(mod)}`;
            }

            setComentario('‚è≥ Eliminando clave...');
            
            try {
                const response = await fetch(`/api/estructura/eliminar?${params}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    ultimosResultados = data;
                    btnRepetirEliminar.style.display = 'block';
                    procesarLogs(data);
                    
                    if (data.encontrado) {
                        log(`‚úÖ ${data.mensaje}`);
                    } else {
                        log(`‚ùå Clave no encontrada`);
                    }
                    
                    // Mostrar animaci√≥n con snapshot
                    mostrarAnimacionBusqueda(data);
                } else {
                    setComentario(`‚ùå ${data.mensaje}`);
                    procesarLogs(data);
                }
            } catch (error) {
                setComentario('‚ùå Error de conexi√≥n: ' + error.message);
            }
        });

        btnRepetirEliminar.addEventListener('click', function() {
            if (ultimosResultados) {
                mostrarAnimacionBusqueda(ultimosResultados);
            }
        });

        btnLimpiar.addEventListener('click', eliminarEstructura);
    }

</script>

</body>
</html>

