<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ciencias de la Computaci√≥n 2</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<div th:fragment="header">
    <!-- ====== T√çTULO PRINCIPAL ====== -->
    <div class="header-principal">
        <h1 class="titulo-principal">Ciencias de la Computaci√≥n 2</h1>
    </div>

    <!-- ====== MEN√ö ====== -->
    <nav class="navbar">
        <ul class="menu">
            <li><a href="#" class="menu-item" data-estructura="lineal">Lineal</a></li>
            <li><a href="#" class="menu-item" data-estructura="binaria">Binaria</a></li>
            <li><a href="#" class="menu-item" data-estructura="arboles-digitales">√Årboles Digitales</a></li>
            <li><a href="#" class="menu-item" data-estructura="tries-residuos">Tries por Residuos</a></li>
            <li><a href="#" class="menu-item" data-estructura="tries-residuos-multiples">Tries por Residuos M√∫ltiples</a></li>
        </ul>
    </nav>
</div>

<!-- ====== CONTENEDOR PRINCIPAL ====== -->
<div class="main-container">
    <!-- ====== MEN√ö LATERAL ====== -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 id="sidebar-title">Selecciona una estructura</h2>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="sidebar-option">Crear</a></li>
            <li><a href="#" class="sidebar-option">Insertar</a></li>
            <li><a href="#" class="sidebar-option">Guardar</a></li>
            <li><a href="#" class="sidebar-option">Recuperar</a></li>
            <li><a href="#" class="sidebar-option">Imprimir</a></li>
            <li><a href="#" class="sidebar-option">Buscar</a></li>
            <li><a href="#" class="sidebar-option">Eliminar</a></li>
        </ul>
    </div>

    <!-- ====== CONTENIDO ====== -->
    <div class="contenido">
        <!-- Secci√≥n inicial (se oculta para Lineal y Binaria) -->
        <div class="contenido-inicial" id="contenido-inicial">
            <div class="titulo">Selecciona una estructura de datos para comenzar</div>
            <div class="subtitulo">
                Elige una opci√≥n en la barra de navegaci√≥n superior para realizar operaciones con diferentes estructuras de datos.
            </div>
        </div>

        <!-- Contenedor de trabajo (se muestra para Lineal y Binaria) -->
        <div class="contenedor-trabajo" id="contenedor-trabajo">
            <!-- Panel izquierdo: Opciones del usuario -->
            <div class="panel-opciones">
                <h3 class="panel-titulo">Opciones</h3>
                <div class="opciones-contenedor" id="opciones-contenedor">
                    <!-- Las opciones se generan din√°micamente aqu√≠ -->
                </div>
            </div>

            <!-- Panel derecho: Visualizaci√≥n de la estructura -->
            <div class="panel-visualizacion">
                <h3 class="panel-titulo">Estructura</h3>
                <div class="scroll-contenedor" id="scroll-contenedor">
                    <div class="estructura-canvas" id="estructura-canvas">
                        <!-- La estructura visual se genera aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Panel inferior: Comentarios -->
            <div class="panel-comentarios" id="panel-comentarios">
                <div class="comentario-icono">‚ÑπÔ∏è</div>
                <div class="comentario-texto" id="comentario-texto">
                    Selecciona una acci√≥n del men√∫ lateral para comenzar
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const menuItems = document.querySelectorAll('.menu-item');
    const sidebarTitle = document.getElementById('sidebar-title');
    const contenidoInicial = document.getElementById('contenido-inicial');
    const contenedorTrabajo = document.getElementById('contenedor-trabajo');
    const comentarioTexto = document.getElementById('comentario-texto');
    const opcionesContenedor = document.getElementById('opciones-contenedor');
    const sidebarOptions = document.querySelectorAll('.sidebar-option');

    let estructuraActual = null;

    const estructuraNames = {
        'lineal': 'Estructura Lineal',
        'binaria': 'Estructura Binaria',
        'arboles-digitales': '√Årboles Digitales',
        'tries-residuos': 'Tries por Residuos',
        'tries-residuos-multiples': 'Tries por Residuos M√∫ltiples'
    };

    const estructurasConPanel = ['lineal', 'binaria'];

    // Evento para items del men√∫ principal
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const estructura = this.getAttribute('data-estructura');
            sidebarTitle.textContent = estructuraNames[estructura];
            estructuraActual = estructura;

            // Mostrar u ocultar el contenedor de trabajo
            if (estructurasConPanel.includes(estructura)) {
                contenidoInicial.style.display = 'none';
                contenedorTrabajo.classList.add('show');
                comentarioTexto.textContent = `${estructuraNames[estructura]} cargada. Selecciona una acci√≥n del men√∫ lateral.`;
                opcionesContenedor.innerHTML = ''; // Limpiar opciones
            } else {
                contenidoInicial.style.display = 'block';
                contenedorTrabajo.classList.remove('show');
            }
        });
    });

    // Evento para opciones del men√∫ lateral
    sidebarOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const accion = this.textContent.trim();

            if (!estructuraActual || !estructurasConPanel.includes(estructuraActual)) {
                alert('Por favor selecciona una estructura (Lineal o Binaria) primero');
                return;
            }

            // Limpiar opciones previas
            opcionesContenedor.innerHTML = '';

            // Mostrar formulario seg√∫n la acci√≥n
            if (accion === 'Crear') {
                mostrarFormularioCrear();
                comentarioTexto.textContent = 'üìù Completa los campos necesarios para crear la estructura';
            } else if (accion === 'Insertar') {
                mostrarFormularioInsertar();
                comentarioTexto.textContent = '‚ûï Ingresa el valor a insertar en la estructura';
            } else if (accion === 'Buscar') {
                mostrarFormularioBuscar();
                comentarioTexto.textContent = 'üîç Ingresa el valor a buscar en la estructura';
            } else if (accion === 'Eliminar') {
                mostrarFormularioEliminar();
                comentarioTexto.textContent = 'üóëÔ∏è Selecciona una acci√≥n para eliminar';
            } else {
                opcionesContenedor.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: rgba(212, 212, 212, 0.7);">
                        Funcionalidad de "${accion}" a√∫n no disponible
                    </div>
                `;
                comentarioTexto.textContent = `‚è≥ La opci√≥n "${accion}" est√° en desarrollo`;
            }
        });
    });

    // Funci√≥n para mostrar formulario de Crear
    function mostrarFormularioCrear() {
        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="tamano-arreglo">Tama√±o del Arreglo</label>
                <input type="number" id="tamano-arreglo" placeholder="Ej: 10" min="1" max="100">
            </div>

            <div class="form-group">
                <label for="tamano-claves">Tama√±o de las Claves</label>
                <input type="number" id="tamano-claves" placeholder="Ej: 5" min="1" max="50">
            </div>

            <div class="form-group">
                <label>Tipo de L√≠mite</label>
                <div class="radio-group">
                    <div class="radio-wrapper">
                        <input type="radio" id="limite-estatico" name="limite" value="estatico" checked>
                        <label for="limite-estatico">Est√°tico</label>
                    </div>
                    <div class="radio-wrapper">
                        <input type="radio" id="limite-dinamico" name="limite" value="dinamico">
                        <label for="limite-dinamico">Din√°mico</label>
                    </div>
                </div>
            </div>

            <button class="btn-accion" id="btn-crear">Crear Estructura</button>
        `;

        document.getElementById('btn-crear').addEventListener('click', async function() {
            const tamanoArreglo = document.getElementById('tamano-arreglo').value;
            const tamanoClaves = document.getElementById('tamano-claves').value;
            const tipeLimite = document.querySelector('input[name="limite"]:checked').value;

            if (!tamanoArreglo || !tamanoClaves) {
                comentarioTexto.textContent = '‚ùå Por favor completa todos los campos';
                return;
            }

            comentarioTexto.textContent = '‚è≥ Creando estructura...';
            
            try {
                const response = await fetch(`/api/estructura/crear?tipo=${estructuraActual}&tamano=${tamanoArreglo}&tamanoClaves=${tamanoClaves}&tipeLimite=${tipeLimite}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    comentarioTexto.textContent = `‚úÖ ${data.mensaje}`;
                    visualizarEstructura(data.claves);
                    document.getElementById('estructura-canvas').innerHTML += `
                        <button class="btn-accion btn-secundario" id="btn-limpiar" style="margin-top: 10px; background: #ff6b6b;">
                            Limpiar y Crear Nueva
                        </button>
                    `;
                    document.getElementById('btn-limpiar').addEventListener('click', eliminarEstructura);
                } else {
                    comentarioTexto.textContent = `‚ùå ${data.mensaje}`;
                }
            } catch (error) {
                comentarioTexto.textContent = '‚ùå Error de conexi√≥n: ' + error.message;
            }
        });
    }

    // Funci√≥n para mostrar formulario de Insertar
    function mostrarFormularioInsertar() {
        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="valor-insertar">Valor a Insertar</label>
                <input type="number" id="valor-insertar" placeholder="Ingresa el valor">
            </div>

            <button class="btn-accion" id="btn-insertar">Insertar</button>
        `;

        document.getElementById('btn-insertar').addEventListener('click', async function() {
            const valor = document.getElementById('valor-insertar').value;
            if (!valor) {
                comentarioTexto.textContent = '‚ùå Por favor ingresa un valor';
                return;
            }

            comentarioTexto.textContent = '‚è≥ Insertando clave...';
            
            try {
                const response = await fetch(`/api/estructura/insertar?clave=${valor}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    comentarioTexto.textContent = `‚úÖ ${data.mensaje}`;
                    visualizarEstructura(data.claves);
                    document.getElementById('valor-insertar').value = '';
                } else {
                    comentarioTexto.textContent = `‚ùå ${data.mensaje}`;
                }
            } catch (error) {
                comentarioTexto.textContent = '‚ùå Error de conexi√≥n: ' + error.message;
            }
        });
    }

    // Funci√≥n para mostrar formulario de Buscar
    function mostrarFormularioBuscar() {
        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="valor-buscar">Valor a Buscar</label>
                <input type="number" id="valor-buscar" placeholder="Ingresa el valor a buscar">
            </div>

            <button class="btn-accion" id="btn-buscar">Buscar</button>
            <button class="btn-accion btn-secundario" id="btn-repetir" style="background: #9d4edd; display: none;">
                üîÑ Repetir Animaci√≥n
            </button>
        `;

        const btnBuscar = document.getElementById('btn-buscar');
        const btnRepetir = document.getElementById('btn-repetir');
        let ultimosResultados = null;

        btnBuscar.addEventListener('click', async function() {
            const valor = document.getElementById('valor-buscar').value;
            if (!valor) {
                comentarioTexto.textContent = '‚ùå Por favor ingresa un valor';
                return;
            }

            comentarioTexto.textContent = '‚è≥ Buscando...';
            
            try {
                const response = await fetch(`/api/estructura/buscar?clave=${valor}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    ultimosResultados = data;
                    btnRepetir.style.display = 'block';
                    
                    if (data.encontrado) {
                        comentarioTexto.textContent = `‚úÖ ${data.mensaje}`;
                    } else {
                        comentarioTexto.textContent = `‚ùå ${data.mensaje}`;
                    }
                    
                    // Mostrar animaci√≥n
                    mostrarAnimacionBusqueda(data);
                } else {
                    comentarioTexto.textContent = `‚ùå ${data.mensaje}`;
                }
            } catch (error) {
                comentarioTexto.textContent = '‚ùå Error de conexi√≥n: ' + error.message;
            }
        });

        btnRepetir.addEventListener('click', function() {
            if (ultimosResultados) {
                mostrarAnimacionBusqueda(ultimosResultados);
            }
        });
    }

    // Funci√≥n para mostrar animaci√≥n de b√∫squeda
    async function mostrarAnimacionBusqueda(datos) {
        const canvas = document.getElementById('estructura-canvas');
        let paso = 0;
        const pasos = datos.pasos;
        
        if (pasos.length === 0) {
            canvas.innerHTML = '<p style="color: #00d4ff;">No hay pasos para mostrar</p>';
            return;
        }
        
        const mostrarPaso = async (index) => {
            if (index >= pasos.length) {
                // √öltima visualizaci√≥n
                visualizarEstructuraConMarcado(datos.claves, datos.encontrado ? datos.posicion : -1, true);
                return;
            }
            
            const paso = pasos[index];
            visualizarEstructuraConMarcado(datos.claves, paso.indiceActual || paso.medio, false);
            
            comentarioTexto.innerHTML = obtenerTextoAnimacion(paso, paso.indiceActual || paso.medio, datos.pasos.length, index + 1);
            
            await new Promise(resolve => setTimeout(resolve, 800));
            mostrarPaso(index + 1);
        };
        
        mostrarPaso(0);
    }

    // Funci√≥n para obtener texto de animaci√≥n
    function obtenerTextoAnimacion(paso, posicion, totalPasos, pasoActual) {
        let texto = `Paso ${pasoActual}/${totalPasos}: `;
        
        if (paso.tipo === "lineal") {
            texto += `Comparando posici√≥n ${posicion} (valor: ${paso.valorActual})`;
            if (paso.esCoincidencia) {
                texto += " ‚úÖ ¬°Coincidencia encontrada!";
            }
        } else if (paso.tipo === "binaria") {
            texto += `B√∫squeda binaria - Rango [${paso.izquierda}, ${paso.derecha}], Medio: ${paso.medio} (valor: ${paso.valorActual})`;
            if (paso.esCoincidencia) {
                texto += " ‚úÖ ¬°Coincidencia encontrada!";
            }
        }
        
        return texto;
    }

    // Funci√≥n para visualizar estructura con marcado
    function visualizarEstructuraConMarcado(claves, indiceMarcado, destacarCompleto) {
        const canvas = document.getElementById('estructura-canvas');
        
        let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">';
        
        claves.forEach((clave, index) => {
            let estilo = 'background: rgba(0, 212, 255, 0.1); border: 2px solid rgba(0, 212, 255, 0.5);';
            
            if (index === indiceMarcado && !destacarCompleto) {
                estilo = 'background: rgba(255, 193, 7, 0.3); border: 3px solid #ffc107; transform: scale(1.1);';
            } else if (destacarCompleto && index === indiceMarcado) {
                estilo = 'background: rgba(76, 175, 80, 0.3); border: 3px solid #4caf50; transform: scale(1.1);';
            }
            
            html += `
                <div style="
                    padding: 12px 16px;
                    ${estilo}
                    border-radius: 6px;
                    color: #00d4ff;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    min-width: 50px;
                    text-align: center;
                ">
                    ${clave}
                </div>
            `;
        });
        
        html += '</div>';
        canvas.innerHTML = html;
    }

    // Funci√≥n para visualizar estructura
    function visualizarEstructura(claves) {
        const canvas = document.getElementById('estructura-canvas');
        visualizarEstructuraConMarcado(claves, -1, false);
    }

    // Funci√≥n para eliminar estructura
    async function eliminarEstructura() {
        comentarioTexto.textContent = '‚è≥ Eliminando estructura...';
        
        try {
            const response = await fetch('/api/estructura/eliminar-estructura', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.exito) {
                comentarioTexto.textContent = `‚úÖ ${data.mensaje}`;
                opcionesContenedor.innerHTML = '';
                document.getElementById('estructura-canvas').innerHTML = 
                    '<p style="color: rgba(212, 212, 212, 0.7);">Estructura eliminada. Selecciona "Crear" para empezar de nuevo.</p>';
            }
        } catch (error) {
            comentarioTexto.textContent = '‚ùå Error: ' + error.message;
        }
    }

    // Funci√≥n para mostrar formulario de Eliminar
    function mostrarFormularioEliminar() {
        opcionesContenedor.innerHTML = `
            <div class="form-group">
                <label for="valor-eliminar">Valor a Eliminar</label>
                <input type="number" id="valor-eliminar" placeholder="Ingresa el valor a eliminar">
            </div>

            <button class="btn-accion" id="btn-eliminar">Eliminar Clave</button>
            <button class="btn-accion btn-secundario" id="btn-repetir-eliminar" style="background: #ff6b6b !important; display: none;">
                üîÑ Repetir Animaci√≥n
            </button>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0, 212, 255, 0.2);">
                <h4 style="color: #00d4ff; margin-top: 0;">Acciones Adicionales</h4>
                <button class="btn-accion" id="btn-limpiar-estruc" style="background: #ff6b6b !important; width: 100%;">
                    üóëÔ∏è Borrar Toda la Estructura
                </button>
            </div>
        `;

        const btnEliminar = document.getElementById('btn-eliminar');
        const btnRepetirEliminar = document.getElementById('btn-repetir-eliminar');
        const btnLimpiar = document.getElementById('btn-limpiar-estruc');
        let ultimosResultados = null;

        btnEliminar.addEventListener('click', async function() {
            const valor = document.getElementById('valor-eliminar').value;
            if (!valor) {
                comentarioTexto.textContent = '‚ùå Por favor ingresa un valor';
                return;
            }

            comentarioTexto.textContent = '‚è≥ Eliminando clave...';
            
            try {
                const response = await fetch(`/api/estructura/eliminar?clave=${valor}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    ultimosResultados = data;
                    btnRepetirEliminar.style.display = 'block';
                    
                    if (data.encontrado) {
                        comentarioTexto.textContent = `‚úÖ ${data.mensaje}`;
                    } else {
                        comentarioTexto.textContent = `‚ùå Clave no encontrada`;
                    }
                    
                    // Mostrar animaci√≥n
                    mostrarAnimacionBusqueda(data);
                } else {
                    comentarioTexto.textContent = `‚ùå ${data.mensaje}`;
                }
            } catch (error) {
                comentarioTexto.textContent = '‚ùå Error de conexi√≥n: ' + error.message;
            }
        });

        btnRepetirEliminar.addEventListener('click', function() {
            if (ultimosResultados) {
                mostrarAnimacionBusqueda(ultimosResultados);
            }
        });

        btnLimpiar.addEventListener('click', eliminarEstructura);
    }
</script>

</body>
</html>

